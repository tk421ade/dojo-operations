{% extends 'base.html' %}

{% block content_header %}
    <h1 class="text-3xl">Welcome {{ student.name }}</h1>
{% endblock %}

{% block style %}
    <style>
        #arrow-container {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 80px;
            background: black;
            clip-path: polygon(0 0, 100% 50%, 0 100%);
            transform: rotate(0deg);
            transition: transform 0.5s;
        }
        #arrow {
            transform: rotate(0deg);
            transition: transform 0.5s;
        }
        @media (prefers-color-scheme: dark) {
            .compass-labels {
                color: #FFFFFF; /* White text for dark mode */
            }
        }

        @media (prefers-color-scheme: light) {
            .compass-labels {
                color: #000000; /* Black text for light mode */
            }
        }
    </style>
{% endblock %}

{% block js %}
    <script>
        var isCloseInTime = false;
        var isCloseInDistance = false;

        function toggleAttendanceForm() {
            if (isCloseInTime && isCloseInDistance) {
                document.getElementById("registrationOpen").style.display = "block";
                document.getElementById("registrationClose").style.display = "none";
            } else {
                document.getElementById("registrationOpen").style.display = "hide";
                document.getElementById("registrationClose").style.display = "block";
            }
        }

        document.addEventListener('DOMContentLoaded', function() {

            const countdownDate = new Date("{{ countdown_date }}"); // Pass the date from Django
            const countdownElement = document.getElementById("countdown");

            function updateCountdown() {
                const now = new Date();
                const distance = countdownDate - now;

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                var str = ""
                var showing = false;
                if (days > 0) {
                    str += `${days} days, `;
                    showing = true;
                }
                if (hours > 0 || showing) {
                    str += `${hours} hours, `;
                    showing = true;
                }
                if (minutes > 0  || showing) {
                    str += `${minutes} minutes, `;
                    showing = true;
                }
                if (seconds > 0  || showing) {
                    str += `${seconds} seconds`;
                }

                countdownElement.innerHTML = `${str}`;

                // if it is closer than 30 minutes
                if ( distance / 1000 < 30 * 60) {
                    isCloseInTime = true;
                }
                toggleAttendanceForm();

            }
            setInterval(updateCountdown, 1000); // Update every second
        });
    </script>
    <script>
        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const earthRadius = 6371; // km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) *
                Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) *
                Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = earthRadius * c;
            return distance;
        }


    </script>
    <script>
        function getTextColor() {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                return '#FFFFFF'; // White text for dark mode
            } else {
                return '#000000'; // Black text for light mode
            }
        }
        function drawHeadingIndicator(canvas, userLocation, targetLocation) {
            // Calculate bearing between user and target locations
            const bearing = getBearing(userLocation, targetLocation);

            // Get canvas context
            const ctx = canvas.getContext('2d');

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw compass labels (N, S, E, W)
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            //ctx.fillStyle = '#000000';
            ctx.fillStyle = getTextColor(); // Call the function to get the text color
            canvas.classList.add('compass-labels');
            ctx.fillText('N', canvas.width / 2, 20);
            ctx.fillText('S', canvas.width / 2, canvas.height - 20);
            ctx.fillText('E', canvas.width - 20, canvas.height / 2);
            ctx.fillText('W', 20, canvas.height / 2);

            // Draw heading indicator (arrow)
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(bearing * Math.PI / 180);
            ctx.beginPath();
            ctx.moveTo(0, -50); // arrow tip
            ctx.lineTo(-20, 20); // arrow tail
            ctx.lineTo(20, 20); // arrow tail
            ctx.closePath();
            ctx.fillStyle = '#FF0000';
            ctx.fill();
            ctx.restore();
        }

        // Calculate bearing between two coordinates
        function getBearing(from, to) {
            const lat1 = from.lat * Math.PI / 180;
            const lon1 = from.lng * Math.PI / 180;
            const lat2 = to.lat * Math.PI / 180;
            const lon2 = to.lng * Math.PI / 180;

            const dLon = lon2 - lon1;
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) -
                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);

            const bearing = Math.atan2(y, x) * 180 / Math.PI;
            return bearing;
        }

    </script>
    <script>
        // print direction and distance
        document.addEventListener('DOMContentLoaded', function() {

            let locationInterval = null;

            function updateCoordinates () {
                navigator.geolocation.getCurrentPosition((position) => {
                    // distance
                    const currentLat = position.coords.latitude;
                    const currentLng = position.coords.longitude;
                    const targetLat = {{address.latitude}}; // Target latitude
                    const targetLng = {{address.longitude}}; // Target longitude
                    console.log(`Latitude: ${currentLat}, Longitude: ${targetLng}`);
                    const distance = calculateDistance(currentLat, currentLng, targetLat, targetLng);

                    // closer than 500 meters
                    if ( distance < 0.5){
                        isCloseInDistance = true;
                    }

                    document.getElementById("distance").innerText = `${distance.toFixed(2)} km`;

                    // direction
                    const canvas = document.getElementById('heading-indicator');
                    const userLocation = {lat: position.coords.latitude, lng: position.coords.longitude};
                    const targetLocation = {lat: {{address.latitude}}, lng: {{address.longitude}}};
                    drawHeadingIndicator(canvas, userLocation, targetLocation);
                }, (error) => {
                    console.error(error);
                }, {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                });
            }

            function startLocationUpdates() {
                locationInterval = setInterval(() => {
                    updateCoordinates();
                }, 10000); // Update every 10 seconds
            }

            updateCoordinates();
            startLocationUpdates();

        });
    </script>
{% endblock %}

{% block content %}
    {% if messages %}
        {% for message in messages %}
            <p>{{ message }}</p>
        {% endfor %}
    {% endif %}

    <h2>{{ session.name }}</h2>
    <p>
        <b>Session hosted by</b>: {{ session.dojo.name }}<br>
        <b>When</b>: {{session.date}}  {{session.time_from}} to {{session.time_to}}<br>
        <b>Where</b>: {{ address.name }} at {{ address.street }}, {{ address.zip_code }} {{ address.city }}, {{ address.state }}
    </p>

    <h2>Registration</h2>
    <div id="registrationOpen" style="display: none">
        <p>Registration is now Open</p>
        <form method="post" action="/student/session/attendance">
            {% csrf_token %}
            <button type="submit">Register Attendance</button>
        </form>
    </div>
    <div id="registrationClose">
        <p>
            1 - Registration opens 30 minutes before the session.<br>The session starts in
            <span  id="countdown"> - calculating - </span>
        <p>
        <p>
            2 - You need to be within 500m when the registration opens. Your current distance is <span id="distance"> - getting gps coordinates - </span>.
            You can get closer with the following bearing:
        </p>
        <canvas id="heading-indicator" width="200" height="200"></canvas>
    </div>
{% endblock %}
